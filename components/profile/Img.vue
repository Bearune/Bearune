<template>
  <div class="profile-picture">
    <svg id="uuid-8624ed69-adcd-401e-b31a-58580e1887db" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496.23 500">
      <g id="uuid-9e30b995-bd5c-4f87-9d30-15212515410d" style="perspective: 1200px;">
        <path
          d="m496.08,250.31c-5.68,157.24-95.29,248-245.88,249.6v.09h-4.17v-.09C95.44,498.31,5.91,407.55.15,250.31c-2.3-64.09,21.54-125.42,67.1-172.76C113.87,29.25,178.85,1.15,246.03.08v-.08h4.17v.08c67.18,1.07,132.15,29.17,178.78,77.47,45.56,47.34,69.4,108.67,67.1,172.76Z"
          class="fill-base-100" style="stroke-width: 0px;" />
        <path id="uuid-884a6f61-afea-41a3-b2d3-93988a5060b3" data-name="bear"
          d="m428.98,77.55C382.36,29.25,317.39,1.15,250.2.08V0h-4.16v.08C178.85,1.15,113.88,29.25,67.26,77.55,21.7,124.89-2.14,186.22.16,250.31c5.76,157.24,95.28,248,245.88,249.6v.09h4.16v-.09c150.6-1.6,240.21-92.36,245.88-249.6,2.31-64.09-21.54-125.42-67.1-172.76Zm-334.07,15.78c4.97-3.63,10.55-6.29,16.49-7.62-5.94,1.5-11.52,4.16-16.49,7.62Zm294.28-7.62c5.94,1.33,11.43,3.99,16.48,7.62-5.05-3.46-10.54-6.12-16.48-7.62Zm89.52,163.98c-1.33,38.02-7.98,71.88-19.5,101.22,6.82-71.62-31.2-168.23-32.71-172.4-2.57-26.06,7.09-57.61-12.94-78.27-.71-.79-1.5-1.5-2.3-2.21-23.49-22.96-47.25-12.77-70.47.35-.44.27-.97.62-1.51.98-2.48,1.42-4.78,2.92-7.26,4.34-.27.18-.54.36-.71.44-1.24.8-2.57,1.6-3.81,2.31-2.75,1.68-5.5,3.19-8.34,4.61,0,.09-.09.09-.09.09-.08,0-.26,0-.26.09-1.15.62-2.31,1.15-3.46,1.68-.26.09-.44.18-.71.27-1.42.62-2.74,1.24-4.16,1.77-6.03,2.39-12.32,4.08-19.06,4.61-16.93,2.3-34.57.97-51.67,1.42-10.29,0-21.01-.09-31.47-1.51-.18,0-.44,0-.62-.09-6.21-.62-12.06-2.22-17.55-4.43-1.42-.53-2.84-1.15-4.26-1.77-.35-.18-.71-.36-1.15-.54-1.06-.53-2.13-1.06-3.19-1.5,0,0-.09,0-.09-.09-2.83-1.42-5.58-2.93-8.33-4.61-1.33-.71-2.57-1.51-3.81-2.31-.27-.17-.53-.26-.71-.44-2.3-1.33-4.52-2.75-6.83-4.16-23.84-13.65-48.3-25.18-72.5-1.51-23.05,20.56-12.5,53.45-15.16,80.48h.09c0,2.66-45.47,113.81-30.84,186.85-15.43-32.44-24.2-71.27-25.8-115.67-2.12-59.39,19.95-116.21,62.23-160.08C123.63,44.14,184.88,17.9,248.17,17.37c63.19.53,124.44,26.77,168.32,72.24,42.28,43.87,64.44,100.69,62.22,160.08Z"
          class="fill-primary dark:fill-base-200" style="stroke-width: 0px;" />
        <path id="uuid-0bb60c17-402b-4d08-913e-6682396b6c3b" :ref="el => (eyes[1] = el)" data-name="left-eye"
          class="fill-base-100 dark:fill-base-content transition-transform duration-100 ease-out"
          d="m167.42,263.25c0,1.06-.18,2.21-.36,3.37v.08c0,.18,0,.36-.09.54-1.06,6.82-3.28,12.05-5.93,15.77-.36.53-.8.98-1.25,1.51-4.78,5.5-10.99,6.91-16.3,4.52-.98-.35-1.78-.8-2.66-1.42-.45-.26-.98-.62-1.42-1.15l-1.33-1.33c-.53-.44-.89-.89-1.24-1.42v-.09c-.8-1.06-1.51-2.21-2.13-3.54-.35-.62-.62-1.33-.89-2.13-.59-1.49-1.07-3.19-1.39-5-.13-.65-.28-1.27-.39-1.95l-.08-.41c-.09-.53-.09-1.06-.17-1.68v-.53c.02.37.09.71.13,1.07-.18-1.61-.4-3.19-.4-4.97v-.71c0-1.24.09-2.39.27-3.46.08-1.15.26-2.21.44-3.28.18-.88.35-1.77.53-2.66.18-.88.36-1.68.62-2.48.36-1.15.71-2.21,1.15-3.19.09-.18.18-.35.27-.53.53-1.24,1.15-2.39,1.77-3.46.09-.18.18-.35.27-.44.62-.89,1.24-1.69,1.86-2.48.8-.89,1.59-1.69,2.39-2.48,1.07-.98,2.22-1.69,3.37-2.31.09,0,.09-.09.18-.09,6.82-3.81,14.62-2.3,18.88,5.67.09.09.17.18.26.36,3.19,6.03,4.08,13.3,3.64,20.3Z"
          style="stroke-width: 0px;" />
        <path id="uuid-00cb1fdc-6b6e-41eb-989f-df434f8f945f" :ref="el => (eyes[0] = el)" data-name="right-eye"
          class="fill-base-100 dark:fill-base-content transition-transform duration-100 ease-out"
          d="m364.72,263.78c0,1.24,0,2.39-.09,3.54v.09c0,.36,0,.62-.08.89-.8,10.02-4.88,16.75-10.02,19.85-.27.09-.53.27-.71.45-3.37,1.77-7,2.04-10.55.8-.53-.09-.97-.36-1.5-.63-.54-.26-1.07-.7-1.69-1.06-1.5-.89-2.92-2.21-4.16-3.9q-.09-.09-.18-.18c-.09-.17-.27-.35-.44-.53v-.09c-.45-.53-.89-1.06-1.16-1.68-2.21-3.55-3.9-8.24-4.78-14.09l-.09-.62c-.18-1.16-.27-2.31-.44-3.46-.09-.8-.09-1.51-.09-2.31v-.44c0-1.06.09-2.22.17-3.28.18-4.96,1.33-9.84,3.64-14.18,1.42-2.75,3.19-4.79,5.23-6.12,3.54-2.3,7.8-2.48,11.87-.88.09.09.18.09.27.09,3.99,1.59,7.8,5.05,10.46,9.92q0,.09.09.18c.18.27.26.53.44.8.18.18.18.35.27.62l.09.09c.08.17.17.35.26.53.09.09.09.27.09.35.09.18.18.36.27.54.35.97.71,1.95,1.06,3.01,1.15,3.72,1.68,7.71,1.77,11.7Z"
          style="stroke-width: 0px;" />
        <path id="uuid-0d455cef-3192-43db-853e-b050f82da629" ref="noseBg" data-name="nose-bg"
          class="fill-base-100 dark:fill-base-content transition-transform duration-100 ease-out"
          d="m304.45,363.05c-.53,1.07-1.15,2.22-1.86,3.28-10.11,18-27.66,30.94-49.11,32.62h-.17c-.45.09-.89.09-1.24.09-1.16.09-2.22.09-3.37.09h-.53c-.11,0-.21-.03-.31-.03-9.22.18-18.51-1.87-27.31-6.51-.09-.05-.17-.09-.26-.13-.92-.5-1.88-.85-2.79-1.4-1.69-1.06-3.37-2.13-5.06-3.46-1.06-.7-2.03-1.5-3.01-2.3-.8-.71-1.59-1.42-2.39-2.13-1.69-1.59-3.37-3.28-4.97-5.05-.97-1.15-1.95-2.3-2.83-3.46-.36-.35-.71-.71-.98-1.15-.26-.35-.62-.71-.88-1.15-.27-.36-.54-.8-.8-1.24-.09-.09-.18-.27-.18-.36-6.65-9.83-10.81-21.45-11.88-33.68,0-.18-.08-.44-.08-.62,0,0-.09-.18,0-.18-2.66-16.22-2.49-33.94.62-49.9.35-2.66.88-5.32,1.5-7.98,0-.08.09-.26.09-.35,0-.35.09-.62.18-.89,0-.17.09-.35.09-.53v-.09c.09-.35.17-.71.35-.97,1.95-7.45,4.88-14.01,8.87-19.77.62-1.15,1.41-2.3,2.3-3.45.36-.45.71-.98,1.06-1.42,5.68-7.18,12.68-12.68,20.3-16.58,2.57-1.24,5.23-2.39,7.89-3.28.09,0,.09-.09.18,0,1.06-.35,2.21-.71,3.28-.97.09-.09.17-.09.26-.09,1.16-.36,2.31-.71,3.46-.89,1.15-.35,2.3-.53,3.55-.71,1.59-.35,3.27-.53,4.96-.62,3.19-.26,6.38-.26,9.57.09,1.07,0,2.13.09,3.28.27.09,0,.27,0,.36.09.26-.09.53,0,.79.08h.36c.44.09.97.18,1.42.27.17,0,.35,0,.53.09.35.09.71.18,1.06.18.45.08.89.26,1.33.26.18.09.36.09.53.18,1.24.27,2.49.62,3.64.89.09.08.17.08.26.08,1.78.54,3.55,1.16,5.23,1.87.8.26,1.6.62,2.31.97.35.18.8.36,1.15.53,5.67,2.66,10.99,6.3,15.78,10.82,2.21,1.95,4.16,4.25,6.02,6.73.36.36.62.8.89,1.16,1.06,1.32,2.04,2.74,2.93,4.16.7,1.15,1.41,2.31,2.03,3.55.27.35.54.79.71,1.24.62,1.15,1.16,2.3,1.69,3.45,0,.09.09.18.09.27.71,1.42,1.24,2.93,1.77,4.43.8,1.95,1.42,4.08,1.95,6.12.35,1.06.62,2.21.89,3.37.08.35.17.79.26,1.15v.18c.36,1.59.62,3.19.89,4.87.26,1.6.53,3.28.71,4.96.26,1.69.44,3.46.53,5.14.18,1.78.26,3.55.35,5.32.18,1.69.18,3.37.18,5.14.09,1.69.09,3.46.09,5.23,0,3.9-.09,7.8-.18,11.7,1.15,15.07-2.13,28.81-8.33,40.42Z"
          style="stroke-width: 0px;" />
        <path id="uuid-e8a8fc1c-b6ca-43c0-b8fa-3e033d81d394" ref="nose" data-name="nose"
          class="fill-base-content dark:fill-base-200 transition-transform duration-100 ease-out"
          d="m283.18,297.64h-.09c-5.05,4.52-14.18,8.42-21.01,11.79-2.48,1.24-4.43,3.28-5.32,5.76l-2.48,6.03c-.8,2.03-.8,4.34-.09,6.47.27.62.71,1.15,1.33,1.59.53.44,1.24.71,1.95.8,8.25.71,18.35,2.22,17.38,6.91-.36,1.95-2.13,3.11-3.99,2.84-7.45-1.33-15.07-1.86-22.69-1.86s-15.69.62-23.32,1.95c-1.68,0-3.1-1.24-3.45-2.93-.89-4.69,9.22-6.2,17.37-6.91,1.51-.09,2.75-1.06,3.28-2.39v-.09c.8-2.04.8-4.35-.09-6.38l-2.39-6.03c-1.07-2.57-2.93-4.61-5.41-5.76-3.54-1.69-7.09-3.46-10.55-5.14-8.68-4.35-17.28-9.93-15.69-20.12,1.07-7.54,8.96-11.79,16.05-13.12,7.98-1.33,16.13-1.78,24.2-1.69,4.87,0,9.75.27,14.53.53,6.56.45,13.47,1.33,18.97,4.79,8.69,5.23,9.13,16.49,1.51,22.96Z"
          style="stroke-width: 0px;" />
      </g>
    </svg>
  </div>
</template>

<script setup>

const eyes = ref([]);
const eyeRect = ref([]);
const eyeCenterX = ref([]);
const eyeCenterY = ref([]);

const nose = ref();
const noseRect = ref();
const noseCenterX = ref();
const noseCenterY = ref();

const noseBg = ref();
const noseBgRect = ref();
const noseBgCenterX = ref();
const noseBgCenterY = ref();

const calculateTranslation = (clientX, clientY, centerX, centerY, rectWidth, rectHeight, maxDistance) => {
  const dx = (clientX - centerX) / rectWidth;
  const dy = (clientY - centerY) / rectHeight;
  const distance = Math.min(Math.sqrt(dx * dx + dy * dy), maxDistance);
  const angle = Math.atan2(dy, dx);
  return {
    x: Math.cos(angle) * distance * (rectWidth / 2),
    y: Math.sin(angle) * distance * (rectHeight / 2),
  };
};

const animation = (e) => {
  eyes.value.forEach((eye, i) => {
    const { x: pupilX, y: pupilY } = calculateTranslation(
      e.clientX, e.clientY, eyeCenterX.value[i], eyeCenterY.value[i], eyeRect.value[i].width, eyeRect.value[i].height, 4
    );
    eye.style.transform = `translate(${pupilX}px, ${pupilY}px)`;

    const { x: noseX, y: noseY } = calculateTranslation(
      e.clientX, e.clientY, noseCenterX.value, noseCenterY.value, noseRect.value.width, noseRect.value.height, 2
    );
    nose.value.style.transform = `translate(${noseX}px, ${noseY}px)`;

    const { x: noseBgX, y: noseBgY } = calculateTranslation(
      e.clientX, e.clientY, noseBgCenterX.value, noseBgCenterY.value, noseBgRect.value.width, noseBgRect.value.height, 0.9
    );
    noseBg.value.style.transform = `translate(${noseBgX}px, ${noseBgY}px)`;
  });
};

const reset = () => {
  eyes.value.forEach((eye) => {
    eye.style.transform = 'translate(0, 0)';
  });
  nose.value.style.transform = 'translate(0, 0)';
  noseBg.value.style.transform = 'translate(0, 0)';
};

const updateElementPosition = (el) => {
  const rect = el.getBoundingClientRect();
  return {
    rect,
    centerX: rect.left + rect.width / 2,
    centerY: rect.top + rect.height / 2
  }

};

const init = () => {
  eyes.value.forEach((eye, i) => {
    //獲取眼睛中心點
    const { rect, centerX, centerY } = updateElementPosition(eye);
    eyeRect.value[i] = rect;
    eyeCenterX.value[i] = centerX;
    eyeCenterY.value[i] = centerY;
  });

  const { rect, centerX, centerY } = updateElementPosition(nose.value);
  noseRect.value = rect;
  noseCenterX.value = centerX;
  noseCenterY.value = centerY;

  const { rect: r, centerX: x, centerY: y } = updateElementPosition(nose.value);
  noseBgRect.value = r;
  noseBgCenterX.value = x;
  noseBgCenterY.value = y;
}

watch(eyes, () => {
  if (device && device.isDesktop) {
    if (eyes.value) {
      init();
      window.addEventListener('scroll', init);
      window.addEventListener('resize', init);
      document.body.addEventListener('pointermove', animation);
      document.body.addEventListener('pointerleave', reset);
    }
    else {
      window.removeEventListener('scroll', init);
      window.removeEventListener('resize', init);
      document.body.removeEventListener('pointermove', animation);
      document.body.removeEventListener('pointerleave', reset);
    }
  }
});

onMounted(async () => {
  await nextTick();
  const device = useDevice();

  // 只有在桌面端添加事件监听
  if (device && device.isDesktop) {
    init();
    window.addEventListener('scroll', init);
    window.addEventListener('resize', init);
    document.body.addEventListener('pointermove', animation);
    document.body.addEventListener('pointerleave', reset);
  };
});

onUnmounted(() => {
  window.removeEventListener('scroll', init);
  window.removeEventListener('resize', init);
  document.body.removeEventListener('pointermove', animation);
  document.body.removeEventListener('pointerleave', reset);
});
</script>

<style lang="scss" scoped></style>